!function(module,$){"use strict";var PORT_BASED_PROTOCOLS=["tcp","udp","sctp"],ICMP_PRESETS={"ICMP ping request":{protocol:"icmp",icmptype:8,icmpcode:0},"ICMPv6 ping request":{protocol:"icmp6",icmptype:8,icmpcode:0},"ICMP ping reply":{protocol:"icmp",icmptype:0,icmpcode:0},"ICMPv6 ping reply":{protocol:"icmp6",icmptype:0,icmpcode:0}},PROTOCOLS=["ip"].concat(PORT_BASED_PROTOCOLS),get_protocols=function(ipv6){return ipv6?PROTOCOLS.concat(["icmp6","ICMPv6 ping request","ICMPv6 ping reply"]):PROTOCOLS.concat(["icmp","ICMP ping request","ICMP ping reply"])},buildQueryParams=function(data){var params=[];return Object.keys(data).forEach(function(key){params.push(key+"="+encodeURIComponent(data[key]))}),params.join("&")},query_route_lookup=function(data){return $.getJSON("/api/v2/monitor/router/lookup?"+buildQueryParams(data))},lookup_policy=function(form_data){var deferred=$.Deferred(),preset=ICMP_PRESETS[form_data.protocol];preset&&$.extend(form_data,preset);var ip_protocol="ip"===form_data.protocol,data=$.extend(form_data,{protocol:ip_protocol?form_data.protocol_number:form_data.protocol,destport:ip_protocol?0:form_data.destport,srcintf:JSON.parse(form_data.srcintf).name}),failure=function(){deferred.reject($.getInfo("Failed to perform policy lookup"))},check_for_route=function(success_fn,failure_fn){query_route_lookup({destination:form_data.dest,ipv6:form_data.ipv6}).then(function(routeData){routeData.results.success?success_fn(routeData.results):failure_fn(routeData.results)},failure)},url="/api/v2/monitor/firewall/policy-lookup?"+buildQueryParams(data);return $.getJSON(url).then(function(data){var results=data.results;results.success?results.policy_id?deferred.resolve(results.policy_id):check_for_route(function(routeData){deferred.reject($.getInfo("pol_lookup_implicit_match",[form_data.srcintf,routeData.interface,results.destip]))},function(){deferred.reject($.getInfo("pol_lookup_no_route",[results.destip]))}):check_for_route(function(routeData){deferred.reject($.getInfo("pol_lookup_no_match",[form_data.srcintf,routeData.interface,results.destip]))},function(){results.destip?deferred.reject($.getInfo("pol_lookup_no_route",[results.destip])):deferred.reject($.getInfo("Failed to resolve FQDN"))})},failure),deferred.promise()},create_input_html=function(params){var type=params.type||"text",classes=params.classes||[],extra_attrs=params.extra_attrs||{},placeholder=params.placeholder||"",style=$.extend({"padding-left":"3px"},params.style),html='<div class="field '+(params.ui_dependencies?"depends":"")+'"';return params.ui_dependencies&&Object.keys(params.ui_dependencies).forEach(function(key){html+=" "+key+'="'+params.ui_dependencies[key]+'"'}),html+=">","select"===type?html+='<label for="'+params.id+'">'+params.label+'</label><div><select id="protocol" name="protocol" class="'+classes.join(" ")+'"> '+params.options.map(function(p){return'<option value="'+p+'">'+$.getInfo(p)+"</option>"})+"</select></div>":"checkbox"===type?html+='<label><span class="toggle-label"><span>'+params.label+'</span><input type="checkbox" class="toggle-switch" id="'+params.id+'" name="'+params.id+'" value="'+params.id+'"><label for="'+params.id+'"></label>':(html+='<label for="'+params.id+'">'+params.label+'</label><div><input type="'+type+'" id="'+params.id+'" name="'+params.id+'" ',html+='class="'+classes.join(" ")+'" placeholder="'+placeholder+'" ',Object.keys(extra_attrs).forEach(function(key){html+=key+'="'+extra_attrs[key]+'" '}),html+='style="',Object.keys(style).forEach(function(key){html+=key+": "+style[key]+"; "}),html+='" /></div>'),html+="</div>"},get_policy_$form=function(){var proto_based_re,forms={};return function(ipv6){var $section,key=ipv6?"ipv6":"ivp4",$form=forms[key];return $form?($form.find("input").removeClass("error"),$form.removeClass("hidden"),$form.find("label.error").remove()):($form=$('<form class="dependency_ignore_visibility"></form>'),forms[key]=$form,$section=$("<section></section").appendTo($form),proto_based_re="/"+PORT_BASED_PROTOCOLS.map(function(proto){return"^"+proto+"$"}).join("|")+"/",ipv6&&$section.append('<input type="hidden" name="ipv6" value="1" />'),$section.append(create_input_html({id:"srcintf",label:$.getInfo("Source Interface"),classes:["required"]})),$section.append(create_input_html({id:"protocol",type:"select",options:get_protocols(ipv6),label:$.getInfo("Protocol"),ipv6:ipv6,classes:["required"]})),$section.append(create_input_html({id:"protocol_number",label:$.getInfo("Protocol Number"),classes:["required","digits"],ui_dependencies:{"data-show-if-value":"ip #protocol"},placeholder:"1-255",extra_attrs:{min:1,max:255}})),$section.append(create_input_html({id:"icmptype",label:$.getInfo("icmptype"),classes:["required","digits"],ui_dependencies:{"data-show-if-value":"/icmp$|icmp6$/ #protocol"},placeholder:"0-255",extra_attrs:{min:0,max:255}})),$section.append(create_input_html({id:"icmpcode",label:$.getInfo("icmpcode"),classes:["required","digits"],ui_dependencies:{"data-show-if-value":"/icmp$|icmp6$/ #protocol"},placeholder:"0-255",extra_attrs:{min:0,max:255}})),$section.append(create_input_html({id:"sourceip",label:$.getInfo("Source"),classes:["required",ipv6?"IP6Checker":"IP4Checker"],placeholder:$.getInfo("ipaddr")})),$section.append(create_input_html({id:"sourceport",type:"number",label:$.getInfo("Source Port"),classes:["digits"],placeholder:$.getInfo("Optional")+" (1-65535)",ui_dependencies:{"data-show-if-value":proto_based_re+" #protocol"},extra_attrs:{min:1,max:65535}})),$section.append(create_input_html({id:"dest",label:$.getInfo("Destination"),classes:["required",ipv6?"IP6Hostname":"Hostname"],placeholder:$.getInfo("IP Address/FQDN")})),$section.append(create_input_html({id:"destport",type:"number",label:$.getInfo("Destination Port"),classes:["required","digits"],ui_dependencies:{"data-show-if-value":proto_based_re+" #protocol"},placeholder:"1-65535",extra_attrs:{min:1,max:65535}}))),$form}}(),create_dialog=function($form,title,lookup_fn){var slide=new Sliderin({title:title,content:$form,buttons:!0,okButtonLabel:$.getInfo("search"),okButtonClick:function(){$form.valid()&&(slide.setLoading(!0),lookup_fn(fweb.util.dom.serializeForm($form)).then(function(policyid){slide.done(policyid)},function(error){slide.setLoading(!1),slide.update({content:'<div class="warning-message">'+error+"</div>",okButton:!1,cancelButtonLabel:$.getInfo("close")})}))}});return $form.ui_dependencies(),$form.validate(),$form.find("#srcintf").omniselect({sources:"firewallInterfaces",filterFunction:function(intf){return"any"!==intf.name&&intf.valid_in_policy&&!intf.is_zone&&!intf.is_virtual_wan_link&&!intf.is_virtual_wire_pair_member},singleSelect:!0,insideSlide:!0}),slide.open(),slide.promise};module.lookup_policy=function(ipv6){var $form=get_policy_$form(ipv6);return create_dialog($form,$.getInfo("Policy Lookup"),lookup_policy)}}(window.PolicyRouteLookup=window.PolicyRouteLookup||{},jQuery);