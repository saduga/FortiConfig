var ReplacementMessage=function($){"use strict";function replacement_message_init(){replacement_message=fweb.opener().ReplacementMessage||ReplacementMessage,$("#replacement_message").length&&$.internationalizeLanguageEntries(),replacement_message["system-msg"]||replacement_message_reload(),replacement_gui_init()}function replacement_message_save(callback,name){var config=replacement_message.config;return name=config.name||name,callback(name),!0}function replacement_message_show(config){$.extend(replacement_message.config,config),replacement_message["update-msg"]={},delete replacement_message["system-msg"];var url="/p/simple/replacement_message.html";return fweb.util.slide.iframe(url)}function replacement_message_reload(config){$.extend(replacement_message.config,config);var type=replacement_message.config.type,name=replacement_message.config.name,msgTypes=replacement_message.config.msgTypes;if(type){delete replacement_message["system-msg"],delete replacement_message["custom-msg"];var jqxhr=cmdb_fetch_customize_messages(type,name);return cmdb_fetch_system_messages(type,msgTypes),jqxhr}}function cmdb_fetch_customize_messages(type,name){var config=replacement_message.config,jqxhr=CMDB.fetch("system","replacemsg-group",{key:"name",pattern:name});return jqxhr.then(function(ret){return ret.results&&ret.results.length?(replacement_message["custom-msg"]=ret.results[0],replacement_gui_init(),ret):(replacement_message["custom-msg"]={"group-type":type},replacement_message["custom-msg"][config.table||type]=[],CMDB.append("system","replacemsg-group",{name:name,"group-type":type,comment:$.getInfo("auto-generated")}).then(replacement_gui_init))},CMDB.notify_failure)}function cmdb_fetch_system_messages(type,msgTypes){function msgTypeFilter(v){if(!(Array.isArray(msgTypes)&&msgTypes.length>0))return!0;var result=msgTypes.some(function(type){return 0===(v["msg-type"]||"").indexOf(type)});return result}var config=replacement_message.config,cmdb_path="system.replacemsg",cmdb_name=config.table||type;if("custom-message"===cmdb_name){if(!config.default||!config.default.table)return replacement_message["system-msg"]=[],void replacement_gui_init();cmdb_name=config.default.table}CMDB.fetch(cmdb_path,cmdb_name).then(function(ret){replacement_message["system-msg"]=(ret.results||[]).filter(msgTypeFilter),replacement_gui_init()},CMDB.notify_failure)}function replacement_highlight_items(){for(var opts=$("li","#msg_list"),i=0;opts[i];i++)highlight_modified_option(opts[i])}function replacement_gui_init(){var gui_ready=$("#replacement_message").length&&replacement_message["system-msg"]&&replacement_message["custom-msg"];if(gui_ready){var msg_list=$("#msg_list");if($("li[selected]",msg_list).length)return replacement_highlight_items();create_customized_dialog(document.body);var config=replacement_message.config,type=config.table||config.type;if("custom-message"===config.table&&config.section)$("<li></li>").attr("sec",config.section).appendTo(msg_list);else for(var msg,i=0;msg=replacement_message["system-msg"][i];i++){var msg_id=msg["msg-type"];msg_id.match(/([\w-]+)(-page-)([2-9])$/)||$("<li></li>").attr("sec",msg_id).text($.getInfo(type+"_"+msg_id.replace(/-page-1$/,"-page"))).appendTo(msg_list)}replacement_highlight_items();var exp=config.section?"[sec="+config.section+"]":":first";$("li"+exp,msg_list).attr("selected","selected"),$("li",msg_list).click(function(){var section=$(this).attr("sec")||config.section.toString();$("li",msg_list).removeAttr("selected"),$(this).attr("selected","selected"),section.match(/([\w-]+)(-page-1)$/)&&(section=RegExp.$1+"-page"),$("#msg_desc").text($.getInfo(type+"_"+section+"_desc")),$("#msg_editor").load(function(){if(config.default){var msg=get_message_obj(config.default.section);$("#default_msg",this.contentWindow.document).val(msg.buffer)}$("#buffer",this.contentWindow.document).val()||$("#menu-revert",this.contentWindow.document).click()}),$("#msg_editor").prop("src","/p/system/replacemsg-group/edit/"+config.name+"/"+type+"/"+section+"/")}),$("li[selected]").click(),$(".std_row:last").autoHeight()}}function highlight_modified_option(opt){var v=$(opt).attr("sec"),msg_obj=array_objectlookup(replacement_custom_msg(),"msg-type",v);$(opt).toggleClass("modified",!(!msg_obj||!msg_obj.buffer))}function get_message_obj(msg_item){return array_objectlookup(replacement_custom_msg(),"msg-type",msg_item)||array_objectlookup(replacement_message["system-msg"],"msg-type",msg_item)}function array_objectlookup(arr,attr,val){var obj;return $.each(arr,function(i,e){if(e[attr]===val)return obj=e,!1}),obj}function replacement_custom_msg(value){var config=replacement_message.config,type=config.table||config.type;return void 0===value?replacement_message["custom-msg"][type]:void(replacement_message["custom-msg"][type]=value)}function create_customized_dialog(){var config=replacement_message.config;$.addLang("/","repmsg"),"custom-message"===config.table&&$("#msg_dlg").addClass("custom")}var replacement_message;return{config:{},init:replacement_message_init,show:replacement_message_show,save:replacement_message_save,reload:replacement_message_reload}}(jQuery);$(document).ready(function(){"use strict";ReplacementMessage.init()});