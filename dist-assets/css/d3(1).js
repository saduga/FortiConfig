define(["angular","jquery","fweb","ng/directives/d3_base","fweb.util/formatters","fweb.util/dom"],function(angular,$,fweb,D3Controller,formatters,dom){"use strict";function setupColorAndStroke(that,$scope){var origColor=that.color,origStroke=that.stroke;that.color=function(){var result;return $scope.colorFn&&(result=$scope.colorFn.apply(that,arguments)),result&&$scope.colorFn||(result=origColor.apply(that,arguments)),result},that.stroke=function(){var result;return $scope.strokeFn&&(result=$scope.strokeFn.apply(that,arguments)),result&&$scope.strokeFn||(result=origStroke.apply(that,arguments)),result}}function D3BubbleController($scope,$element,$injector){$injector.invoke(D3Controller,this,{$scope:$scope,$element:$element}),this.init(),this.ready.then(function(){setupColorAndStroke(this,$scope),this.bubble=this.d3.layout.pack().sort(null).size([this.width,this.height]).padding(2)}.bind(this))}function quickTransition(collection,attrs,styles,textFn){var transition=collection.transition().duration(BUBBLE_TRANSITION_DURATION);attrs&&transition.attr(attrs),styles&&transition.style(styles),textFn&&transition.text(textFn)}function pluckDeviceName(d){return"destination"===d._segmentType?d.resolved||d.dstaddr:"country"===d._segmentType?d.country:d.alias||d.hostname||(d.device?$.getInfo("User::Device::Short::type."+d.device):"")||d.label}function toPx(num){return(num||0).toFixed(4)+"px"}function valueFormatter(d){return this.$scope.shownKeyFormatter(d)}function D3CountryController($scope,$element,$injector,$http,$templateCache,$compile,loader){$injector.invoke(D3Controller,this,{$scope:$scope,$element:$element});var countriesJSON=loader.base_path("/geo/countries.json"),legendTemplate=loader.base_path("/ng/directives/d3_country_legend.html");this.promises.push($http.get(countriesJSON,{cache:!0}).then(function(result){this.geoData=result.data}.bind(this))),this.promises.push($http.get(legendTemplate,{cache:$templateCache}).then(function(template){this.$legend=$compile(template.data)(this.$scope).appendTo(this.$element)}.bind(this))),this.$scope.legendFormatter=function(value){var result="";return value&&(result=angular.isFunction(this.$scope.legendValueFormatter)?this.$scope.legendValueFormatter(value):value),result}.bind(this),this.COUNTRY_MAP={"Bosnia and Herz.":"Bosnia and Herzegovina","Central African Rep.":"Central African Republic","Czech Rep.":"Czech Republic","Dominican Rep.":"Dominican Republic","Dem. Rep. Congo":"Congo, The Democratic Republic of the","Eq. Guinea":"Equatorial Guinea","Falkland Is.":"Falkland Islands (Malvinas)",Iran:"Iran, Islamic Republic of",Korea:"Korea, Republic of",Libya:"Libyan Arab Jamahiriya",Moldova:"Moldova, Republic of",Russia:"Russian Federation",Syria:"Syrian Arab Republic","S. Sudan":"South Sudan",Tanzania:"Tanzania, United Republic of"},this.COUNTRY_EXEMPT={"Aland Islands":!0,"American Samoa":!0,Andorra:!0,Anguilla:!0,"Anonymous Proxy":!0,Antarctica:!0,"Antigua and Barbuda":!0,Aruba:!0,"Asia/Pacific Region":!0,Bahrain:!0,Barbados:!0,Bermuda:!0,"Bonaire, Saint Eustatius and Saba":!0,"Brunei Darussalam":!0,"Cape Verde":!0,"Cayman Islands":!0,"Christmas Island":!0,"Cook Islands":!0,Curacao:!0,Dominica:!0,Europe:!0,Gibraltar:!0,Guadeloupe:!0,Guam:!0,Guernsey:!0,Grenada:!0,"Faroe Islands":!0,"French Guiana":!0,"French Polynesia":!0,"French Southern Territories":!0,"Hong Kong":!0,"Isle of Man":!0,Jersey:!0,Liechtenstein:!0,Macao:!0,Maldives:!0,Malta:!0,Mauritius:!0,Martinique:!0,"Marshall Islands":!0,Mayotte:!0,"Micronesia, Federated States of":!0,Monaco:!0,Montserrat:!0,Nauru:!0,Niue:!0,"Norfolk Island":!0,"Northern Mariana Islands":!0,Palau:!0,"Palestinian Territory":!0,Pitcairn:!0,Reserved:!0,Reunion:!0,"Saint Bartelemey":!0,"Saint Helena":!0,"Saint Kitts and Nevis":!0,"Saint Martin":!0,"Saint Pierre and Miquelon":!0,"Saint Lucia":!0,"Saint Vincent and the Grenadines":!0,Samoa:!0,"San Marino":!0,"Sao Tome and Principe":!0,Seychelles:!0,Singapore:!0,"Sint Maarten":!0,"Solomon Islands":!0,"South Georgia and the South Sandwich Islands":!0,"Svalbard and Jan Mayen":!0,Tokelau:!0,Tonga:!0,"Turks and Caicos Islands":!0,Tuvalu:!0,"United States Minor Outlying Islands":!0,"Virgin Islands, British":!0,"Virgin Islands, U.S.":!0,"Wallis and Futuna":!0},this.country_warned={},this.scale=1,this.translation=[0,0];var countryCentersJSON=loader.base_path("/geo/country_centers.json");this.promises.push($http.get(countryCentersJSON,{cache:!0}).then(function(result){this.countryCenters=result.data}.bind(this))),this.init(),this.ready=this.ready.then(function(){this.svg=this.svg.append("g"),this.colorScale=this.d3.scale.linear().range(["#FFEF40","#C7311A"]),this.color=function(value){return 0===value?"#D9D5D4":this.colorScale(value)}.bind(this)}.bind(this))}function D3ThreatMapController($scope,$element,$injector,$interval,shortcuts){$injector.invoke(D3CountryController,this,{$scope:$scope,$element:$element}),this.$interval=$interval,this.scale=.8,this.translation=[0,.5],this.attackData=[],this.countryMap=null,this.countryHeat={},this.resizeTransition=null,this.countryColorRange=["#36424A","#7D7E7E"],this.threatLevelNames=["","Low","Medium","High","crit"],this.threatLevelColors=["#62a1d7","#faffa5","#ffca5c","#f32e2b"],this.api=this.$scope.api=this.$scope.api||{},this.api.attackData=this.attackData,this.api.processThreats=this.processThreats.bind(this),shortcuts.subscribe(shortcuts.SHORTCUTS.CONTRA,function(){this.svg.selectAll("*").remove(),this.egg=!0,this.rendered=!1,this.update(this.$scope.data)}.bind(this),"shortcut::easter_egg")}function D3ChordController($scope,$element,$injector,fortiviewUtil,csfTopology){$injector.invoke(D3Controller,this,{$scope:$scope,$element:$element}),this.init(),this.fortiviewUtil=fortiviewUtil,this.fortigateTooltip=this.createTooltipBindFn(function(group){return this.entities[group.index].fortigate}.bind(this)),this.interfaceTooltip=this.createTooltipBindFn(function(group,element){var intfData=this.entities[group.index],csfFortigate=csfTopology.fortigateMapping[intfData.fortigate];dom.formatObject({element:element,mkey:intfData.intf,datasource:"firewallInterfaces",csfPath:csfFortigate&&csfFortigate.path})}.bind(this)),this.$q.all(this.promises).then(function(){setupColorAndStroke(this,$scope),this.setupChart()}.bind(this))}var BUBBLE_TRANSITION_DURATION=1e3;D3BubbleController.prototype=Object.create(D3Controller.prototype),D3BubbleController.prototype.constructor=D3BubbleController,D3BubbleController.prototype.update=function(data){this.bubble.size([this.width,this.height]),data=this.bubble.nodes({children:data}).filter(function(d){return d.name&&d.value&&!d.children});var node=this.svg.selectAll(".node").data(data,function(d){return d.name}),enter=node.enter().append("g").attr("class","node").attr("transform",function(d){return"translate("+d.x+","+d.y+")"});enter.append("circle").attr("r",function(d){return d.r}).style({fill:function(d){return this.color(d.name,d)}.bind(this),stroke:function(d){return this.stroke(d.name,d)}.bind(this),cursor:this.clickSupported?"pointer":"auto"}).on("click",this.clickFn).each(this.tooltipBindFn);var textFn=function(d){var fullLabel=String(d.label||d.name),maxLength=d.r/3-2,label=fullLabel.substring(0,maxLength);return label.length<=2&&fullLabel.length>2?label="":fullLabel.length!==label.length&&d.shortLabel&&(label=d.shortLabel.length>maxLength?"":d.shortLabel),label};this.renderBubbleInner(enter,node);var nodes=node.select("circle").each(this.tooltipBindFn).transition().duration(BUBBLE_TRANSITION_DURATION).attr("r",function(d){return d.r}).style({fill:function(d){return this.color(d.name,d)}.bind(this),stroke:function(d){return this.stroke(d.name,d)}.bind(this),cursor:this.clickSupported?"pointer":"auto"});if(0===nodes.size()){if(!this.placeholder){var langs=this.$scope.placeholderLang||["No data found","Check FortiView requirements"],placeholder=this.placeholder=this.svg.append("text").attr("text-anchor","middle").attr("pointer-events","none");langs.forEach(function(lang,index){placeholder.append("tspan").text($.getInfo(lang)).attr("x","0").attr("dy",index+"em")})}this.placeholder.attr("transform","translate("+this.width/2+","+this.height/2+")")}else this.placeholder&&(this.placeholder.remove(),this.placeholder=null);node.select("text.label").text(textFn).each(this.tooltipBindFn),node.transition().attr("class","node").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),node.exit().remove()};var MAX_AREA=7;D3BubbleController.prototype.renderBubbleInner=function(enterNode,deviceNode){var valueFormat=valueFormatter.bind(this);deviceNode.each(function(d){var name=pluckDeviceName(d)||"",nameLength=name.length,value=valueFormat(d),valueLength=(value+"").length,totalLength=nameLength+valueLength+2,availableWidth=2*d.r,availableTextHeight=availableWidth/MAX_AREA,textFontSize=Math.min(2*availableWidth/totalLength,availableTextHeight,15);d._textFontSize=textFontSize,d._name=name,d._value=value}),this.updateBubbleIcon(enterNode,deviceNode),this.updateBubbleDescription(enterNode,deviceNode)},D3BubbleController.prototype.updateBubbleIcon=function(enterNode,deviceNode){var iconClass=function(){return"bubble-icon"},iconSize=function(d){return toPx(4*d.r/MAX_AREA)},iconDy=function(d){return toPx(-1.5*d.r/MAX_AREA)},iconFontFamily=function(d){return d.iconFontFamily||""},iconAttrs={"font-size":iconSize,class:iconClass,dy:iconDy,"font-family":iconFontFamily,"text-anchor":"middle"};if(enterNode&&deviceNode){var iconTextFn=function(d){return d.iconCode||""},iconStyles={"pointer-events":"none"};enterNode.append("text").text(iconTextFn).attr(iconAttrs).style(iconStyles),quickTransition(deviceNode.select("text.bubble-icon"),iconAttrs,iconStyles,iconTextFn)}},D3BubbleController.prototype.updateBubbleDescription=function(enterNode,deviceNode){var txtSize=function(d){return toPx(d._textFontSize)},txtNameDy=function(d){return toPx(d._textFontSize/2)},txtValueDy=function(d){return toPx(4*d.r/MAX_AREA)},baseAttr={"font-size":txtSize,"text-anchor":"middle"},txtNameAttrs=angular.extend({class:"name",dy:txtNameDy},baseAttr),txtValueAttrs=angular.extend({class:"value",dy:txtValueDy},baseAttr);if(enterNode&&deviceNode){var txtNameFn=function(d){return d._name},txtValueFn=function(d){return d._value},txtStyles={"pointer-events":"none"};enterNode.append("text").text(txtNameFn).attr(txtNameAttrs).style(txtStyles),enterNode.append("text").text(txtValueFn).attr(txtValueAttrs).style(txtStyles),quickTransition(deviceNode.select("text.name"),txtNameAttrs,txtStyles,txtNameFn),quickTransition(deviceNode.select("text.value"),txtValueAttrs,txtStyles,txtValueFn)}};var d3BasicBubbleChart=function(){return{restrict:"A",scope:{data:"=",click:"=",tooltipFormatter:"=",colorFn:"=",strokeFn:"=",tooltipCreateBindFn:"=",shownKeyFormatter:"=",placeholderLang:"="},controller:D3BubbleController}};D3CountryController.prototype=Object.create(D3Controller.prototype),D3CountryController.prototype.constructor=D3CountryController,D3CountryController.prototype.requireComponents=function(){return D3Controller.prototype.requireComponents.call(this,{topojson:"js/topojson"})},D3CountryController.prototype.createPath=function(features){var scale,translate,topLeft={x:null,y:null},bottomRight={x:null,y:null},projection=this.egg?this.d3.geo.orthographic().scale(1.2).translate([0,0]).clipAngle(90).rotate([100,0]).precision(.1):this.d3.geo.mercator().scale(this.scale).translate(this.translation),path=this.d3.geo.path().projection(projection);return features.forEach(function(feature){var value,bounds=path.bounds(feature);value=bounds[0][0],(null==value||value<topLeft.x)&&(topLeft.x=value),value=bounds[0][1],(null==value||value<topLeft.y)&&(topLeft.y=value),value=bounds[1][0],(null==value||value>bottomRight.x)&&(bottomRight.x=value),value=bounds[1][1],(null==value||value>bottomRight.y)&&(bottomRight.y=value),this.countryCenters&&this.countryCenters[feature.properties.iso_a2]&&(feature.center=[this.countryCenters[feature.properties.iso_a2].long,this.countryCenters[feature.properties.iso_a2].lat])}.bind(this)),scale=.95/Math.max((bottomRight.x-topLeft.x)/this.width,(bottomRight.y-topLeft.x)/this.height),translate=[(this.width-scale*(topLeft.x+bottomRight.x))/2,(this.height-scale*(topLeft.y+bottomRight.y))/2],projection.scale(scale).translate(translate),path},D3CountryController.prototype.update=function(data){var features=this.topojson.feature(this.geoData,this.geoData.objects.countries).features,path=this.createPath(features),hit={};this.colorScale.domain([0,data._meta.max]),this.$scope.minNonZeroValue=data._meta.max===data._meta.minNonZero?null:data._meta.minNonZero,this.$scope.maxValue=data._meta.max;var getStats=function(d){var name=d.properties.name;name=this.COUNTRY_MAP[name]||name;var value={name:name,country:name};return data[name]&&(value=data[name],hit[name]=!0),value}.bind(this),fillFn=function(d){var stats=getStats(d);return this.color(stats.value||0)}.bind(this);this.tooltipDataGetter=getStats,this.tooltipColorKeyGetter=function(d){var name=d.properties.name;return data[name]?data[name].value:0},this.rendered?this.svg.selectAll("path").attr("d",path).transition().duration(1e3).style({fill:fillFn,cursor:this.clickSupported?"pointer":"auto"}):(this.svg.selectAll("path").data(features,function(d){return d.properties.name}).enter().append("path").attr("class","country").attr("d",path).style({fill:fillFn,cursor:this.clickSupported?"pointer":"auto"}).on("click",function(d){this.clickFn(getStats(d))}.bind(this)).each(this.tooltipBindFn),this.rendered=!0),Object.keys(data).forEach(function(country){"_meta"===country||hit[country]||this.COUNTRY_EXEMPT[country]||this.country_warned[country]||(fweb.log('Country "'+country+"\" doesn't exist on map"),this.country_warned[country]=!0)}.bind(this))};var d3CountryChart=function(){return{restrict:"A",scope:{data:"=",click:"=",tooltipFormatter:"=",legendValueFormatter:"="},controller:D3CountryController}};D3ThreatMapController.prototype=Object.create(D3CountryController.prototype),D3ThreatMapController.prototype.update=function(data){var features=this.topojson.feature(this.geoData,this.geoData.objects.countries).features;this.countryMap=features.reduce(function(map,f){return map[f.properties.iso_a2]=f,map},{});var path=this.path=this.createPath(features);data.device||(data.device={latitude:0,longitude:0}),this.$fortigate=$(data.deviceElement),this.setupFortigateDragging(data.device);var fillFn=function(d){var countryColorFn=this.d3.scale.linear().range(this.countryColorRange);return countryColorFn(this.countryHeat[d.properties.iso_a2]||0)}.bind(this);if(this.rendered)this.resizeTransition=this.svg.selectAll("path.country").style({fill:fillFn}).transition().duration(1e3).attr("d",path),this.redrawNightMap();else{this.svg.selectAll("path").data(features,function(d){return d.properties.name}).enter().append("path").attr("class","country").attr("d",path).style({fill:fillFn,"stroke-opacity":.7}),this.redrawNightMap=this.renderNightMap();var updateLocked=!1,updateInterval=this.$interval(function(){updateLocked||(updateLocked=!0,this.d3.timer(function(){var target=this.resizeTransition||this.svg.selectAll("path.country");return target.transition().ease("linear").duration(1e4).style({fill:fillFn}),this.resizeTransition=null,updateLocked=!1,!0}.bind(this)))}.bind(this),1e3);if(this.egg){var rotate=[71.03,.37],velocity=[.018,-6e-5];this.d3.timer(function(elapsed){if(!this.egg)return!0;var projection=this.path.projection();projection.rotate([rotate[0]+elapsed*velocity[0],rotate[1]+elapsed*velocity[1]]);var position=projection([data.device.longitude,data.device.latitude]),visible=!!this.path({type:"MultiPoint",coordinates:[[data.device.longitude,data.device.latitude]]});this.$fortigate.toggleClass("clipped",!visible),this.$fortigate.css({left:position[0],top:position[1]}),this.svg.selectAll("path").attr("d",this.path)}.bind(this))}this.$scope.$on("$destroy",function(){this.$interval.cancel(updateInterval),this.egg=!1}.bind(this)),this.rendered=!0}},D3ThreatMapController.prototype.setupFortigateDragging=function(device){var position=this.path.projection()([device.longitude,device.latitude]),maxHeight=this.height-this.$fortigate.height();this.$fortigate.css({left:position[0],top:Math.max(Math.min(position[1],maxHeight),0)}),device.draggable&&(this.$fortigate.draggable(),this.$fortigate.off("drag").on("drag",function(e,ui){var svgBounds=this.svg.node().getBBox();ui.position.left=Math.max(svgBounds.x+10,ui.position.left),ui.position.left=Math.min(svgBounds.x+svgBounds.width-10,ui.position.left),ui.position.top=Math.max(0,ui.position.top),ui.position.top=Math.min(maxHeight,ui.position.top)}.bind(this)),this.$fortigate.off("dragstop").on("dragstop",function(e,ui){if(this.path.projection().invert){var position=[ui.position.left,ui.position.top],coords=this.path.projection().invert(position);device.latitude=coords[1],device.longitude=coords[0]}}.bind(this)))},D3ThreatMapController.prototype.processLogLines=function(){var loglines=this.d3.select("#threatlog table").selectAll("tr.log").data(this.filteredData,function(d){return d.threatid}),line=loglines.enter().append("tr").attr("class","log").style("color",function(d){return this.threatLevelColors[d.level]}.bind(this));line.append("td").attr("class","flag").html(function(d){return'<span class="country_flag country_'+d.countrycode+'"></span>'}.bind(this)),line.append("td").attr("class","location").text(function(d){var country=this.countryMap[d.countrycode];return country.properties.name}.bind(this)),line.append("td").attr("class","threat").text(function(d){return $.getInfo(d.threat)}),line.append("td").attr("class","level").text(function(d){return $.getInfo(this.threatLevelNames[d.level])+" ("+d.score+")"}.bind(this)),line.append("td").attr("class","time").text(function(d){var formattedTime=new Date(1e3*d.time).toLocaleString();return formattedTime});var threatlog=this.d3.select("#threatlog .logs").node();threatlog.scrollTop=threatlog.scrollHeight,loglines.exit().remove()},D3ThreatMapController.prototype.processThreats=function(){var that=this,getFortigatePosition=function(){var position=that.$fortigate.position();return[position.left,position.top]};this.filteredData=this.attackData.filter(function(d){return d.countrycode=that.countryMap[d.src_country]?d.src_country:d.dst_country,!!that.countryMap[d.countrycode]}),this.processLogLines();var groups=this.svg.selectAll("g.threat").data(this.filteredData).enter().append("g").attr("class","threat");groups.attr("transform",function(d){var country=this.countryMap[d.countrycode];return this.countryHeat[d.countrycode]=(this.countryHeat[d.countrycode]||0)+1,d.origin=country.center?this.path.projection()(country.center):this.path.centroid(country),"translate("+d.origin+")"}.bind(this)).transition().ease("linear").duration(2e3).attr("transform",function(d){d.fortigatePos=getFortigatePosition(),d.slopeX=d.origin[0]-d.fortigatePos[0],d.slopeY=d.origin[1]-d.fortigatePos[1],d.length=Math.sqrt(d.slopeX*d.slopeX+d.slopeY*d.slopeY),d.fgtVector=[d.slopeX/d.length,d.slopeY/d.length];var finalVector=[d.fortigatePos[0]+20*d.fgtVector[0],d.fortigatePos[1]+20*d.fgtVector[1]];return"translate("+finalVector+")"}).transition().ease("linear").duration(1e3).attr("transform",function(d){var finalVector=[d.fortigatePos[0]+100*d.fgtVector[0],d.fortigatePos[1]+100*d.fgtVector[1]];return"translate("+finalVector+")"}).transition().delay(1e4).each("end",function(d){that.countryHeat[d.countrycode]=(that.countryHeat[d.countrycode]||1)-1,that.d3.select(this).selectAll("*").remove()}),groups.append("circle").attr("stroke",function(d){return this.threatLevelColors[d.level]}.bind(this)).attr("fill",function(d){return this.threatLevelColors[d.level]}.bind(this)).attr("r",1.5).transition().delay(2e3).duration(1e3).attr("fill","none").attr("r",20).style("opacity",0).style("stroke-width",5),groups.append("line").attr("stroke",function(d){return this.threatLevelColors[d.level]}.bind(this)).attr("stroke-width",2).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0).transition().ease("linear").duration(200).attr("x2",function(d){return d.fgtVector[0]*(d.length/10)}).attr("y2",function(d){return d.fgtVector[1]*(d.length/10)}).transition().delay(2e3).ease("linear").duration(1).attr("x2",0).attr("y2",0)},D3ThreatMapController.prototype.renderNightMap=function(){function antipode(position){return[position[0]+180,-position[1]]}function solarPosition(time){var centuries=(time-Date.UTC(2e3,0,1,12))/864e5/36525,longitude=(that.d3.time.day.utc.floor(time)-time)/864e5*360-180;return[longitude-equationOfTime(centuries)*degrees,solarDeclination(centuries)*degrees]}function equationOfTime(centuries){var e=eccentricityEarthOrbit(centuries),m=solarGeometricMeanAnomaly(centuries),l=solarGeometricMeanLongitude(centuries),y=Math.tan(obliquityCorrection(centuries)/2);return y*=y,y*Math.sin(2*l)-2*e*Math.sin(m)+4*e*y*Math.sin(m)*Math.cos(2*l)-.5*y*y*Math.sin(4*l)-1.25*e*e*Math.sin(2*m)}function solarDeclination(centuries){return Math.asin(Math.sin(obliquityCorrection(centuries))*Math.sin(solarApparentLongitude(centuries)))}function solarApparentLongitude(centuries){return solarTrueLongitude(centuries)-(.00569+.00478*Math.sin((125.04-1934.136*centuries)*radians))*radians}function solarTrueLongitude(centuries){return solarGeometricMeanLongitude(centuries)+solarEquationOfCenter(centuries)}function solarGeometricMeanAnomaly(centuries){return(357.52911+centuries*(35999.05029-1537e-7*centuries))*radians}function solarGeometricMeanLongitude(centuries){var l=(280.46646+centuries*(36000.76983+3032e-7*centuries))%360;return(l<0?l+360:l)/180*Math.PI}function solarEquationOfCenter(centuries){var m=solarGeometricMeanAnomaly(centuries);return(Math.sin(m)*(1.914602-centuries*(.004817+14e-6*centuries))+Math.sin(m+m)*(.019993-101e-6*centuries)+289e-6*Math.sin(m+m+m))*radians}function obliquityCorrection(centuries){return meanObliquityOfEcliptic(centuries)+.00256*Math.cos((125.04-1934.136*centuries)*radians)*radians}function meanObliquityOfEcliptic(centuries){return(23+(26+(21.448-centuries*(46.815+centuries*(59e-5-.001813*centuries)))/60)/60)*radians}function eccentricityEarthOrbit(centuries){return.016708634-centuries*(42037e-9+1.267e-7*centuries)}var radians=Math.PI/180,degrees=180/Math.PI,that=this,circle=this.d3.geo.circle().angle(90),night=this.svg.append("path").attr("class","night").style({stroke:"black",fill:"black","fill-opacity":".3","stroke-opacity":".2"}).attr("d",this.path),redraw=function(){night.datum(circle.origin(antipode(solarPosition(new Date)))).attr("d",this.path)}.bind(this);return redraw(),redraw};var d3ThreatMap=function(){return{restrict:"A",scope:{data:"=",api:"="},controller:D3ThreatMapController}};D3ChordController.prototype=Object.create(D3Controller.prototype),D3ChordController.prototype.constructor=D3ChordController,D3ChordController.prototype.setupChart=function(){this.svg=this.svg.append("g").attr("transform","translate("+this.width/2+","+this.height/2+")"),this.chordGroup=this.svg.append("g").attr("class","chord")},D3ChordController.prototype.update=function(data){function padSmall(d){var smallFactor=1-d.value/d.maxGroupValue;return-.03*smallFactor}function fade(opacity,chords){return function(g,i){chords.filter(function(d){return d.source.index!==i&&d.target.index!==i}).transition("fade").style("opacity",opacity)}}function chordTween(chord){return function(d,i){var tween,previous=chord&&chord.chords()[i];if(previous)tween=that.d3.interpolate(previous,d);else{var emptyChord={source:angular.extend({},d.source,{endAngle:d.source.startAngle}),target:angular.extend({},d.target,{endAngle:d.target.startAngle})};tween=that.d3.interpolate(emptyChord,d)}return function(t){return chordGen(tween(t))}}}function arcTween(chord){return function(d,i){var tween,previous=chord&&chord.groups()[i];if(previous)tween=that.d3.interpolate(previous,d);else{var zeroArc={startAngle:d.startAngle,endAngle:d.startAngle};tween=that.d3.interpolate(zeroArc,d)}return function(t){return arcGen(tween(t))}}}function countFormatter(count){return count}if(data.matrix.every(function(row){return row.every(function(value){return 0===value})}))return this.chart=null,this.svg.selectAll("*").remove(),void(this.chordGroup=this.svg.append("g").attr("class","chord"));var that=this,arcGen=this.d3.svg.arc().padAngle(padSmall),csfArcGen=this.d3.svg.arc().padAngle(padSmall),chordGen=this.d3.svg.chord(),fontSize=13.8,entityToEntity=data.dataMap;this.existingChordTransistion||this.existingArcTransition||(this.previousChart=this.chart),this.chart=this.d3.layout.chord().padding(.1),this.svg.attr("transform","translate("+this.width/2+","+this.height/2+")");var innerRadius=.39*Math.min(this.width,this.height),outerRadius=1.1*innerRadius,outerOuterRadius=1.1*outerRadius,arcWidth=outerRadius-innerRadius;arcGen.innerRadius(innerRadius).outerRadius(outerRadius),csfArcGen.innerRadius(outerRadius).outerRadius(outerOuterRadius),chordGen.radius(innerRadius),this.entities=data.entities,this.tooltipColorKeyGetter=function(d){return that.entities[d.target.index].key},this.chart.matrix(data.matrix);var chords=this.chordGroup.selectAll("path.chord").data(this.chart.chords);chords.enter().append("path").attr("class","chord").style("fill","white").style("stroke","white").style("opacity",.85),this.existingChordTransistion=chords.each(function(d){var source,destination,chordSource=that.entities[d.source.index].key,chordDestination=that.entities[d.target.index].key,srcToDest=entityToEntity[chordSource][chordDestination],dstToSrc=entityToEntity[chordDestination][chordSource];srcToDest.realValue>dstToSrc.realValue?(source=chordSource,destination=chordDestination):(source=chordDestination,destination=chordSource),d.fillEntity=destination,d.strokeEntity=source,d.data=angular.copy(entityToEntity[source][destination]),srcToDest!==dstToSrc&&(d.data.reversed=entityToEntity[destination][source])}).each(this.tooltipBindFn).on("click",function(d){return d.source===d.target?that.clickFn(d):void that.$scope.$apply(function(){that.$scope.drillDownMenu.formatters={bytes:formatters.metric_bytes,packets:countFormatter,bandwidth:formatters.metric_bits_per_second,shaper_drops:formatters.metric_bytes,sessions:countFormatter},that.$scope.drillDownMenu.entry=d.data,that.$scope.drillDownMenu.toggle({top:that.d3.event.clientY,left:that.d3.event.clientX})})}).transition().duration(1e3).style({fill:function(d){return that.color(d.fillEntity,d)},stroke:function(d){return that.stroke(d.strokeEntity,d)},cursor:this.clickSupported?"pointer":"auto"}).attrTween("d",chordTween(this.previousChart)).each("end",function(){that.existingChordTransistion=null}),chords.exit().remove();var csfGroup,arcGroups=this.svg.selectAll("g.intf").data(this.chart.groups),fortigateData=angular.copy(this.chart.groups());if(fortigateData=fortigateData.filter(function(group,i){return i<=0?(csfGroup=group,!0):that.entities[csfGroup.index].fortigate===that.entities[group.index].fortigate?(csfGroup.endAngle=group.endAngle,csfGroup.fortigate=that.entities[group.index].fortigate,!1):(csfGroup=group,!0)}),this.fortiviewUtil.csfEnabled()){var csfArcs=this.svg.selectAll("g.fortigate").data(fortigateData),newCsfArcs=csfArcs.enter().append("g").attr("class","fortigate");newCsfArcs.append("path").attr("class","csfArc").attr("id",function(d){return"path"+d.index}).style("fill","white").style("stroke","white").append("title");var maxGroupValue=Math.max.apply(null,this.chart.groups().map(function(group){return group.value})),csfArcPaths=csfArcs.select("path.csfArc").each(function(d){d.maxGroupValue=maxGroupValue}).style("fill",function(d){return that.color(that.entities[d.index].fortigate,d)}).style("stroke",function(d){return that.stroke(that.entities[d.index].fortigate,d)}).attr("d",csfArcGen);csfArcs.each(this.fortigateTooltip),csfArcs.exit().remove(),newCsfArcs.append("text").append("textPath").attr("xlink:href",function(d){return window.location.href+"#path"+d.index}),csfArcs.select("g.fortigate text").attr("dx",5).attr("dy",arcWidth/2+fontSize/2),csfArcs.select("g.fortigate text textPath").text(function(group,i){var thickness=outerRadius-innerRadius,maxChars=(csfArcPaths[0][i].getTotalLength()/2-thickness)/fontSize,fgt=that.entities[group.index].fortigate;return fgt.substring(0,maxChars-1)+(maxChars<fgt.length?"...":"")})}var newArcGroups=arcGroups.enter().append("g").attr("class","intf");newArcGroups.append("path").attr("class","arc").style("fill","white").style("stroke","white").append("title"),newArcGroups.append("text").style("fill","white"),arcGroups.select("text").each(function(d){d.angle=(d.startAngle+d.endAngle)/2}).text(function(d){var entity=that.entities[d.index].intf,entityExtra=data.entitiesExtra[entity];return entityExtra&&entityExtra.label||entity}).style("text-anchor",function(d){return d.angle>Math.PI?null:"end"}).attr("transform",function(d){return"rotate("+(180*d.angle/Math.PI-90)+")translate("+(innerRadius-10)+",0)"+(d.angle>Math.PI?"rotate(180)":"")}).transition().duration(1e3).style("fill","black"),this.existingArcTransition=arcGroups.select("path.arc").each(this.interfaceTooltip).each(function(d){d.maxGroupValue=maxGroupValue}).transition().duration(1e3).style("fill",function(d){return that.color(that.entities[d.index].key,d)}).style("stroke",function(d){return that.stroke(that.entities[d.index].key,d)}).attrTween("d",arcTween(this.previousChart)).each("end",function(){that.existingArcTransition=null}),arcGroups.on("mouseover",fade(.1,chords)).on("mouseout",fade(.85,chords)),arcGroups.exit().remove()};var d3ChordChart=function(){return{restrict:"A",scope:{data:"=",click:"=",tooltipFormatter:"=",drillDownMenu:"="},controller:D3ChordController}};return function(providers){providers.$compile.directive("fD3BasicBubbleChart",d3BasicBubbleChart),providers.$compile.directive("fD3CountryChart",d3CountryChart),providers.$compile.directive("fD3ThreatMap",d3ThreatMap),providers.$compile.directive("fD3ChordChart",d3ChordChart)}});