define(["angular","jquery","ftnt_shared"],function(angular,$,ftnt_shared){"use strict";function D3Controller($scope,$element,$q,$window,$timeout){this.id="d3Chart"+Math.floor(1+65536*Math.random()),this.$scope=$scope,this.$element=$element,this.$q=$q,this.$window=$window,this.$timeout=$timeout,this.promises=[this.requireComponents().then(function(){var parent=this.d3.select(this.$element[0]);this.scrollable&&(parent=parent.append("div").attr("class","d3-chart-scrollbox")),this.svg=parent.append("svg"),this.scrollable||this.svg.attr("class","no-scroll"),this.color=this.d3.scale.category20c(),this.stroke=function(value,data){var color=this.d3.rgb(this.color(value,data));return color.darker(.5)}.bind(this)}.bind(this))]}var MOTION_CHECK_INTERVAL=100;return D3Controller.prototype.init=function(){if(this.width=this.$element.width(),this.height=this.$element.height(),this.$element.addClass("d3-chart"),this.$loading=angular.element('<div class="d3-chart-loading"><f-icon class="fa-loading icon-xxxl"></f-icon></div>').appendTo(this.$element),this.setupClick(),angular.isFunction(this.$scope.tooltipFormatter)){var tooltipFormatter=this.tooltipBindFn=this.createTooltipBindFn();if(angular.isFunction(this.$scope.tooltipCreateBindFn)){var tooltipCreateBindFn=this.$scope.tooltipCreateBindFn;this.tooltipBindFn=function(d){return tooltipCreateBindFn(d,this)||tooltipFormatter.call(this,d)}}}else this.tooltipBindFn=angular.noop;this.ready=this.$q.all(this.promises).then(function(){this.setupWatch()}.bind(this))},D3Controller.prototype.requireComponents=function(extra){var required={d3:"js/d3"};required=angular.extend(required,extra);var requiredModules=Object.keys(required),requiredPaths=requiredModules.map(function(module){return required[module]}),deferred=this.$q.defer();return require(requiredPaths,function(){for(var i=0;i<arguments.length;i++)this[requiredModules[i]]=arguments[i];deferred.resolve()}.bind(this)),deferred.promise},D3Controller.prototype.setupClick=function(){this.clickSupported=!1,this.clickFn=function(d){this.clickSupported&&this.$scope.$apply(function(){this.$scope.click(d.data?d.data:d)}.bind(this))}.bind(this),this.$scope.$watch("click",function(click){this.clickSupported=angular.isFunction(click),this.render(this.$scope.data)}.bind(this))},D3Controller.prototype.tooltipDataGetter=function(d){return d.data?d.data:d},D3Controller.prototype.tooltipColorKeyGetter=function(d){return d.data?d.data.name:d.name},D3Controller.prototype.createTooltipBindFn=function(content){this.$tooltip||(this.$tooltip=new ftnt_shared.Tooltip({class:"d3-tooltip",padContent:!0}));var that=this;return function(d){var $this=$(this),mouseLeave="mouseleave.tooltip",mouseEnter="mouseenter.tooltip";$this.off(mouseLeave).on(mouseLeave,that.$tooltip.hide.bind(that.$tooltip)),$this.off(mouseEnter).on(mouseEnter,function(event){var $div=$("<div></div>"),html=angular.isFunction(content)?content(d,$div):angular.isString(content)?content:that.$scope.tooltipFormatter(that.tooltipDataGetter(d));$div.append(html),that.$tooltip.show($div[0],event.pageX,event.pageY)})}},D3Controller.prototype.setupWatch=function(){var motionCheck=function(that,lastWidth,lastHeight){var width=that.$element.width(),height=that.$element.height();return width===lastWidth&&height===lastHeight?(that.width=width,that.height=height,that.motionCheck=null,that.$scope.data&&that.render(that.$scope.data,!0)):that.$timeout(motionCheck,MOTION_CHECK_INTERVAL,!0,that,width,height),!0};this.$scope.$watch(function(){return{width:this.$element.width(),height:this.$element.height()}}.bind(this),function(size,oldSize){size.width===oldSize.width&&size.height===oldSize.height||(this.motionCheck=this.motionCheck||motionCheck(this))}.bind(this),!0),motionCheck(this),this.$scope.$watch("data",function(data){this.render(data)}.bind(this)),angular.element(this.$window).on("resize."+this.id,function(){this.motionCheck=this.motionCheck||motionCheck(this)}.bind(this)),this.$scope.$on("$destroy",function(){angular.element(this.$window).off("resize."+this.id),this.$tooltip&&this.$tooltip.destroy()}.bind(this))},D3Controller.prototype.render=function(data,ignoreLoading){ignoreLoading||this.$loading.toggleClass("hidden",!1),this.$q.when(data,function(data){null!=data&&this.width&&this.height&&(this.$loading.toggleClass("hidden",!0),this.update(data))}.bind(this))},D3Controller});