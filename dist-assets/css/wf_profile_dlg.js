function new_quota_fn(){"use strict";var qId=++ftgdCat.maxQuotaId;ftgdCat.newEditQuota(launch_cat_quota_dialog,qId)}function edit_quota_fn(qId){"use strict";ftgdCat.newEditQuota(launch_cat_quota_dialog,qId,ftgdCat.quota[qId])}function getQuotaQlistsource(){"use strict";var quotas=[];for(var i in ftgdCat.quota){var quota=ftgdCat.quota[i];if("undefined"!=typeof quota&&"undefined"!=typeof quota.cat){var obj=ftgdCat.getQuotaRowData(quota);quotas.push(obj)}}return quotas}function refreshQuotaQlist(){"use strict";var quotas=getQuotaQlistsource()||[];gen_wf_quota_qlist(quotas)}function launch_cat_quota_dialog(curQuotaId){"use strict";function form_submit(){var quotaType,$quotaValue,quotaValue,quotaTimeUnit,catsArr=newFtgdCat.getChkedCats4Quota(),quotaValues={};if(catsArr.length<=0)alert($.getInfo("err_no_category"));else if(quotaType=quotaValues.type=$("input:radio[name=quota-type]:checked").val()||DEFAULT_QUOTA_TYPE,$quotaValue=$("#quota-"+quotaType),$form.valid()){switch(quotaValue=parseInt($quotaValue.val()),quotaType){case"time":quotaTimeUnit=$("#quota-unit-time :selected").data("unit"),quotaValues.dur=quotaValue*quotaTimeUnit;break;case"traffic":quotaValues.value=quotaValue,quotaValues.unit=$("#quota-unit-"+quotaType).val()}ftgdCat.updateQuota(curQuotaId,catsArr,quotaValues),$(this).dialog("destroy"),refreshQuotaQlist()}return!1}var title=$.getInfo("editq"),$dialog=$("#wf-cat-quota-dlg"),$form=$dialog.find("form");$dialog.addClass("dlg_treeview"),$("#quota-treeDivCat").jstree("destroy");var i,cat,eligCat=ftgdCat.eligCat||[],grpMembers=[],catsAction=[];for(i=0;cat=eligCat[i];i++)grpMembers[cat.grpId]||(grpMembers[cat.grpId]=[]),grpMembers[cat.grpId].push(new IdentityCategory({id:cat.category.id,name:cat.category.name})),catsAction[cat.category.id]={action:cat.category.actionCode,warnDuration:cat.category.dur,usrgrp:cat.category.usrgrp};var eligGrp=ftgdCat.eligGrp||[],quotaData=ftgdCat.curQuotaData,quotaCats=quotaData&&quotaData.cat||[],newEligGrp=eligGrp.map(function(val){return new IdentityGroup(parseInt(val.id,10),val.name)}),newFtgdCat=new WebfFtgd,options={noContextMenu:!0,noSearch:!0};newFtgdCat.init(newEligGrp,grpMembers,catsAction,options),$.extend(newFtgdCat,{curCatsInQuota:quotaCats}),newFtgdCat.grps.sort(newFtgdCat.sortGroups),newFtgdCat.buildTree("quota-treeDivCat");var DEFAULT_QUOTA_TYPE="time",DEFAULT_QUOTA_TIME_DURATION=300,DEFAULT_QUOTA_TRAFFIC_VALUE=500,DEFAULT_QUOTA_TRAFFIC_UNIT="MB",quotaType=quotaData&&quotaData.type||DEFAULT_QUOTA_TYPE,quotaDur=quotaData&&quotaData.dur||DEFAULT_QUOTA_TIME_DURATION,quotaVal=quotaData&&quotaData.value||DEFAULT_QUOTA_TRAFFIC_VALUE,quotaTrafficUnit=quotaData&&quotaData.unit||DEFAULT_QUOTA_TRAFFIC_UNIT,maxUnit=getMaxTimeUnit(quotaDur);$form.find("#quota-type-"+quotaType).attr("checked",!0),$form.find("#quota-time").val(Math.floor(quotaDur/getMaxTimeUnit.TIME_LIMITS[maxUnit])).removeClass("error"),$form.find("#quota-unit-time").val(getMaxTimeUnit.TIME_UNITS.indexOf(maxUnit)),$form.find("#quota-traffic").val(quotaVal).removeClass("error"),$form.find("#quota-unit-traffic").val(quotaTrafficUnit),$form.validate({rules:{"quota-time":{required:!0,min:1},"quota-traffic":{required:!0,min:1}},errorLabelContainer:"#quota-error"}),$form.valid(),$form.submit(form_submit),$dialog.dialog({title:title,resizable:!1,minWidth:600,modal:!0,buttons:[{text:$.getInfo("ok"),click:form_submit},{text:$.getInfo("cancel"),click:function(){$(this).dialog("destroy")}}]}),$.ui_dependencies()}function gen_restrict_access_domains_qlist(){"use strict";var h=gen_restrict_access_domains_qlist.handlers=gen_restrict_access_domains_qlist.handlers||new QListInlineHandlers($('[name="restrict_google_domains"]'),{read_only:!is_rw_admin||restrict_google_domains_readonly},"[f-ng-app=qlistMenuBar-restrict_google_accounts]");h.set_defaults({domain:"",wp_profile_name:""}),$("#restrict_access_domains").qlist(h.attach({prefix:"restrict_access_domains",columns:[{selector:"domain",validate:"required url_noscheme"}],options:{inline:!0}}))}function configOmniselects(){"use strict";function filterProfile(entry){var name=$("#name").val();return entry.name!==name&&"sniffer-profile"!==entry.name}var selectConfig={"override_ovrd-user-group":{sources:["user.group"],preProcessSelected:!0},override_profile:{sources:["webfilter.profile"],filterFunction:filterProfile,preProcessSelected:!0}};for(var id in selectConfig){var $elem=$("#"+id);$elem.length&&$elem.omniselect(selectConfig[id])}}function launch_webcontent_filter_dialog(wfcontent_entries,operation,source_index){"use strict";var is_edit=operation===OPERATIONS.EDIT,title=is_edit?$.getInfo("Edit Web Content Filter"):$.getInfo("New Web Content Filter"),$dialog=$("#wc_filter_dialog"),$name_field=$("#wc_filter_name"),$type_field=$("#wc_filter_pattern-type"),$status_field=$("#wc_filter_status"),$lang_field=$("#wc_filter_lang"),$action_field=$("#wc_filter_action"),$form=$dialog.find("form"),wcf_profile=is_edit?wfcontent_entries[source_index]:{};"regexp"===wcf_profile["pattern-type"]&&(wcf_profile["pattern-type"]="regex"),is_edit?($name_field.val(wcf_profile.name),$type_field.find("input[value="+wcf_profile["pattern-type"]+"]").check(),$status_field.check("enable"===wcf_profile.status),$lang_field.val(wcf_profile.lang),$action_field.find("input[value="+wcf_profile.action+"]").check()):($name_field.val(""),$type_field.find('input[value="wildcard"]').check(),$status_field.check(!1),$lang_field.val("western"),$action_field.find('input[value="block"]').check()),$form.submit(function(){return!1}),$dialog.dialog({title:title,resizable:!1,minWidth:550,modal:!0,buttons:[{text:$.getInfo("ok"),click:function(){$form.valid()&&(wcf_profile.name=$name_field.val(),wcf_profile["pattern-type"]=$type_field.find("input:checked").val(),wcf_profile.status=$status_field.is(":checked")?"enable":"disable",wcf_profile.lang=$lang_field.val(),wcf_profile.score=bword_threshold,wcf_profile.action=$action_field.find("input:checked").val(),operation===OPERATIONS.CREATE?wfcontent_entries.push(wcf_profile):operation===OPERATIONS.EDIT&&(wfcontent_entries[source_index]=wcf_profile),$(this).dialog("destroy"),gen_webcontent_qlist(wfcontent_entries))}},{text:$.getInfo("cancel"),click:function(){$(this).dialog("destroy")}}]})}function gen_webcontent_qlist(wfcontent_entries){"use strict";function WebContentFilterListMenuController($scope,$rootScope){wfContentMenuReset=function(){$rootScope.qlistElem={element:$("#webcontent_filter")}},wfContentMenuReset(),$scope.create=function(){launch_webcontent_filter_dialog(wfcontent_entries,"create")},$scope.edit=function(){var index=$scope.qlistElem.element.find("tr.selected").data("sourceIndex");launch_webcontent_filter_dialog(wfcontent_entries,"edit",index)},$scope.editEnabled=function(entries){return entries&&1===entries.length},$scope.delete=function(){var rows=$scope.qlistElem.element.find("tr.selected").toArray(),indices=rows.map(function(row){return $(row).data("sourceIndex")});indices.sort(function(a,b){return b-a}),indices.forEach(function(index){wfcontent_entries.splice(index,1)}),gen_webcontent_qlist(wfcontent_entries)}}var columns=[{selector:"pattern-type"},{selector:"name",lang_key:"field_pattern"},{selector:"lang"},{selector:"action"},{selector:"status"}],qlist_settings={source:wfcontent_entries,prefix:"website_filter_webcontent_filter",search:{enabled:!0},paging:{enabled:wfcontent_entries.length>gui_lines_per_page},default_columns:columns.map(function(column){return column.selector}),columns:columns,options:{inline:!0},format_fn:{"pattern-type":function(td,column,row){var pattern_type=row["pattern-type"];return"regexp"===pattern_type&&(pattern_type="regex"),"<span>"+$.getInfo(pattern_type)+"</span>"},action:function(td,column,row){return td.addClass("left"),fweb.util.icon.formatIcon(fweb.util.icon.ICON_TYPE.URL_FILTER_ACTION,row.action,{label:$.getInfo(row.action)})},status:function(td,column,row){return td.addClass("left"),fweb.util.icon.formatIcon(fweb.util.icon.ICON_TYPE.ENABLE_DISABLE,row.status,{label:$.getInfo(row.status)})},lang:function(td,column,row){return"<span>"+$.getInfo(row.lang)+"</span>"},name:function(td,column,row){return $(td).addClass("left"),fweb.util.formatters.truncate_comment(row.name,50,"qtip-popup")}}};require(["angular","jquery.ng_app"],function(angular,ng_app){if($("#webcontent_filter").empty().removeData().qlist(qlist_settings),$("#webcontent_filter").find(".qtip-popup").ftip(),wfContentMenuReset)wfContentMenuReset();else{var ngModule=angular.module("WebContentFilterListMenu",[]);ngModule.controller(ng_app.DEFAULT_QLIST_MENU_ITEMS_CONTROLLER,WebContentFilterListMenuController),$("[f-ng-app=qlistMenuBarWebContentFilterTableMenu]").ng_app({modules:[ngModule.name]})}})}function gen_wf_quota_qlist(wfquota_entries){"use strict";function WebFilterQuotaListMenuController($scope,$rootScope){quotaMenuReset=function(){$rootScope.qlistElem={element:$("#wf_quota")}},quotaMenuReset(),$scope.create=function(){new_quota_fn()},$scope.edit=function(){var entry=$scope.menu.lastSelectedEntry,qId=entry.id;edit_quota_fn(qId)},$scope.editEnabled=function(entries){return entries&&1===entries.length},$scope.delete=function(){for(var id,entries=$scope.menu.entries,i=0;i<entries.length;i++)id=entries[i].id,"undefined"==typeof ftgdCat.quota[id].old?delete ftgdCat.quota[id]:ftgdCat.quota[id].qtState=PROFILE_DEL;refreshQuotaQlist()}}function quota_format(td,col,entry){return"traffic"===entry.type?entry.value+entry.unit:entry.duration}var settings={source:wfquota_entries,columns:[{selector:"category",lang_key:"category"},{selector:"quota",lang_key:"quota"}],options:{inline:!0},format_fn:{quota:quota_format},prefix:"quota"};require(["angular","jquery.ng_app"],function(angular,ng_app){try{if($("#wf_quota").empty().removeData().qlist(settings),quotaMenuReset)quotaMenuReset();else{var ngModule=angular.module("WebFilterQuotaListMenu",[]);ngModule.controller(ng_app.DEFAULT_QLIST_MENU_ITEMS_CONTROLLER,WebFilterQuotaListMenuController),$("[f-ng-app=qlistMenuBarWebFilterQuotaTableMenu]").ng_app({modules:[ngModule.name]})}}catch(e){}})}function loadFtgdCategoryRating(){"use strict";var $ratings=$('input[name="ratings"]');$ratings.length&&$ratings.change(function(){var selectedRating=$('input[name="ratings"]:checked').val();ftgdCat.updateCategoryTreeByRating(selectedRating),$("#sel_action_filter").omniselect("getInstance").update({selected:[{q_origin_key:"all",name:"all",datasource:"fortiGuardCategoryActions"}],reProcess:!0})})}function loadData(){"use strict";return fweb.util.webfilter.getRatingMap()}function ready(ratingMap){"use strict";function clone(mkey){return fweb.cmdbClone.wfProfile(mkey,wfcontent_id,urlfilter_id).then(function(new_profile){return new_profile.mkey})}function post_delete(){wfcontent_id&&CMDB.delete("webfilter","content",wfcontent_id),urlfilter_id&&CMDB.delete("webfilter","urlfilter",urlfilter_id)}$.ui_dependencies(),window.UTMProfiles.setCloneHandler(clone),window.UTMProfiles.setPostDelete(post_delete),gen_webcontent_qlist(wfcontent_entries),gen_restrict_access_domains_qlist(),ftgdCat=new WebfFtgd(ratingMap),ftgdCat.init(categoryGroups,grpMembers,catsAction,null,refreshQuotaQlist),$.extend(ftgdCat,{quota:quota}),ftgdCat.setMaxQuotaId(),ftgdCat.buildTree(),window.WebfilterShared.gen_urlfilter_qlist(urlfilter_entries,is_wf_adv_visible),window.WebfilterShared.setupFortiGuardCatsHandlers(ftgdCat,is_licensed),refreshQuotaQlist(),loadFtgdCategoryRating(),configOmniselects(),$(".fa-help-info.qtip-popup").ftip(),$("form").submit(function(){$("#ftgd_cat").val(JSON.stringify(ftgdCat)),urlfilter_entries.map(function(entry){delete entry.q_origin_key}),$("#url_filter_entries").val(JSON.stringify(urlfilter_entries)),$("#wfcontent_entries").val(JSON.stringify(wfcontent_entries));var result=$(this).valid()&&gen_restrict_access_domains_qlist.handlers.update_form();return result}).validate({onsubmit:!1,rules:{name:{DuplicateEntryChecker:[{path:"webfilter",name:"profile"}]}}}),is_rw_admin||$(":input").not("#sel_profile").enable(!1)}var ftgdCat,OPERATIONS={CREATE:"create",EDIT:"edit",DELETE:"delete",INSERT_ABOVE:"insert_above",INSERT_BELOW:"insert_below"},wfContentMenuReset,quotaMenuReset;$(function(){"use strict";$(document).ready(function(){loadData().then(ready)})});