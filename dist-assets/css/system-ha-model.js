define(["angular","fweb.util/formatters"],function(angular,f_formatters){"use strict";function factory(CMDB){function quotedStringSplit(str){for(var match,split=new RegExp(QUOTED_STRING_SPLIT_EXPR),result=[];match=split.exec(str);)result.push(match[1]);return result}function makeDatasourceEntry(datasource,name){var entry={name:name,datasource:datasource};return entry[Omniselect.prototype.ENTRY_ID_KEY]=name,"system.vdom"===datasource&&(entry["css-class"]=f_formatters.vdom_icon_class(name)),entry}function VCluster(haModel){this._haModel=haModel}function SystemHaModel($initPromise,lang){this._init(),monitorInterfaceMixin(this["secondary-vcluster"]),$initPromise.then(function(){this.$schema.$promise=this.$schema.$promise.then(function(schema){return this.$schema.children.mode.options.forEach(function(opt){opt.lang=lang("System::HA::mode."+opt.name)}),this.$schema.children.hbdev.$priority={min:0,max:512,default:0},this._initHbdev(),schema}.bind(this))}.bind(this)),this.$vclusters=SystemHaModel.getVClusters(this)}function monitorInterfaceMixin(target){Object.defineProperty(target,"$monitor",{get:function(){return this._monitor||(this._monitor=quotedStringSplit(this.monitor).map(makeDatasourceEntry.bind(null,"haFirewallInterfaces"))),this._monitor},set:function(value){value=value||[],this._monitor=value,this._storeMonitor(value)},enumerable:!0}),target._storeMonitor=function(value){void 0===value&&(value=this._monitor||[]),this.monitor=value.map(function(v){return'"'+v[Omniselect.prototype.ENTRY_ID_KEY]+'"'}).join(" ")}}var QUOTED_STRING_SPLIT_EXPR=/(?:"([^"]+)") ?/g;return VCluster.prototype={_haModel:null,_vdomString:null,_vdoms:null,get vdoms(){if(this._vdomString===this._haModel.vdom)return this._vdoms;var result,vdoms=quotedStringSplit(this._haModel.vdom);return this._vdomString=this._haModel.vdom,result=vdoms.map(makeDatasourceEntry.bind(null,"system.vdom")),this._vdoms=result},set vdoms(value){function pluckId(vd){return vd[idKey]}var idKey=Omniselect.prototype.ENTRY_ID_KEY;value=value||[],this._haModel.vdom='"'+value.map(pluckId).join('" "')+'"',this._vdomString=this._haModel.vdom,this._vdoms=value}},monitorInterfaceMixin(VCluster.prototype),SystemHaModel.getVClusters=function(model){return[new VCluster(model),new VCluster(model["secondary-vcluster"])]},SystemHaModel.filters={monitor:function(intf){return intf.is_ha_monitorable},hbdev:function(intf){return intf.is_ha_heartbeatable}},SystemHaModel.prototype=new CMDB.ResourceModel({$save:function(){return this._storeHbdev(),this._storeMonitor(),this["secondary-vcluster"]._storeMonitor(),"a-p"!==this.mode&&(this.$vcluster2=!1),CMDB.ResourceModel.prototype.$save.apply(this,arguments)},get $sessionPickup(){return"enable"===this["session-pickup"]},set $sessionPickup(value){this["session-pickup"]=value?"enable":"disable"},get $hbdev(){return this.$$hbdev},set $hbdev(value){this.$schema&&this.$schema.$promise.then(function(){value&&value.forEach(function(dev){dev.name in this.$hbdevPriority||(this.$hbdevPriority[dev.name]=this.$schema.children.hbdev.$priority.default)}.bind(this)),this._storeHbdev(value)}.bind(this)),this.$$hbdev=value},get $syncMgmtVdom(){return"disable"===this["standalone-mgmt-vdom"]},set $syncMgmtVdom(value){this["standalone-mgmt-vdom"]=value?"disable":"enable"},get $mgmtStatus(){return"enable"===this["ha-mgmt-status"]},set $mgmtStatus(value){this["ha-mgmt-status"]=value?"enable":"disable"},get $vcluster2(){return"enable"===this.vcluster2},set $vcluster2(value){this.vcluster2=value?"enable":"disable"},_init:function(){this.password&&(this.password=void 0);var cmdb=new CMDB("system","ha",{children:"ha-mgmt-interfaces",shortcuts:!1});this["ha-mgmt-interfaces"].$factory=cmdb.defaults.bind(cmdb),0===this["ha-mgmt-interfaces"].length&&this["ha-mgmt-interfaces"].push(cmdb.defaults()),this["ha-mgmt-interfaces"].forEach(function(entry){var intf=entry.interface;intf&&(entry.interface=makeDatasourceEntry("global::haFirewallInterfaces",intf.name))})},_storeHbdev:function(value){void 0===value&&(value=this.$hbdev),this.hbdev=value.map(function(v){return'"'+v.name+'" '+this.$hbdevPriority[v.name]}.bind(this),[]).join(" ")},_initHbdev:function(){var match,device,split=/(?:"([^"]+)") (\d+) ?/g;for(this.$$hbdev=[],this.$hbdevPriority={};match=split.exec(this.hbdev);)device=makeDatasourceEntry("haFirewallInterfaces",match[1]),device[Omniselect.prototype.ENTRY_ID_KEY]=device.name,this.$$hbdev.push(device),this.$hbdevPriority[device.name]=Number(match[2])||this.$schema.children.hbdev.$priority.default},mgmtFilter:function(intf){function hasName(name){return function(mgmtIntf){var entry=mgmtIntf.interface;return entry&&entry.name===name}}var haMgmtIntfs=this.$original&&this.$original["ha-mgmt-interfaces"],preselected=haMgmtIntfs.some(hasName(intf.name));return preselected||intf.is_ha_mgmt_candidate},mgmtIntfUnique:function(value,index){return!this["ha-mgmt-interfaces"].some(function(intf,i){return intf.interface&&intf.interface.name===value.name&&i!==index})}}),monitorInterfaceMixin(SystemHaModel.prototype),SystemHaModel}return function(providers){providers.$provide.factory("SystemHaModel",factory)}});